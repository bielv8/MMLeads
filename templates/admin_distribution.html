{% extends "base.html" %}

{% block title %}Distribuição de Leads - MM Conecta Leads{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-share-alt me-2"></i>Distribuição de Leads</h1>
</div>

<div class="row">
    <!-- Distribution Configuration -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cog me-2"></i>Configurações de Distribuição</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('save_distribution_config') }}">
                    <div class="mb-3">
                        <label for="mode" class="form-label">Modo de Distribuição</label>
                        <select class="form-select" name="mode" id="mode" required onchange="toggleManualOrder()">
                            <option value="round_robin" {{ 'selected' if config and config.mode.value == 'round_robin' }}>
                                Round Robin (Rotação Automática)
                            </option>
                            <option value="manual" {{ 'selected' if config and config.mode.value == 'manual' }}>
                                Ordem Manual (Prioridade Fixa)
                            </option>
                        </select>
                        <div class="form-text">
                            Round Robin distribui leads igualmente entre corretores ativos. 
                            Ordem Manual segue sua lista de prioridade especificada.
                        </div>
                    </div>
                    
                    <div class="mb-3" id="manualOrderSection" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-sort me-1"></i>Ordem de Prioridade dos Corretores
                            <small class="text-muted">(Arraste para reordenar)</small>
                        </label>
                        <div id="brokerOrderList" class="sortable-list">
                            {% if config and config.broker_order %}
                                {% for broker_id in config.broker_order %}
                                    {% for broker in brokers %}
                                        {% if broker.id == broker_id %}
                                            <div class="d-flex align-items-center mb-2 broker-order-item" data-broker-id="{{ broker.id }}">
                                                <i class="fas fa-grip-vertical text-muted me-2 drag-handle"></i>
                                                <span class="badge bg-primary me-2 order-number">{{ loop.index }}</span>
                                                <div class="flex-grow-1">
                                                    <strong>{{ broker.username }}</strong>
                                                    <small class="text-muted d-block">{{ broker.email }}</small>
                                                </div>
                                                <span class="badge bg-{{ 'success' if broker.is_active else 'secondary' }} me-2">
                                                    {{ 'Ativo' if broker.is_active else 'Inativo' }}
                                                </span>
                                                <input type="hidden" name="broker_order" value="{{ broker.id }}">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBrokerFromOrder(this)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div class="mt-2">
                            <select id="brokerSelect" class="form-select">
                                <option value="">Selecione corretor para adicionar...</option>
                                {% for broker in brokers %}
                                    <option value="{{ broker.id }}">{{ broker.username }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addBrokerToOrder()">
                                <i class="fas fa-plus me-1"></i>Adicionar Corretor
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="skip_inactive" id="skip_inactive" 
                                   {{ 'checked' if config and config.skip_inactive }}>
                            <label class="form-check-label" for="skip_inactive">
                                Pular corretores inativos
                            </label>
                            <div class="form-text">
                                Pular automaticamente corretores marcados como inativos ou que não podem receber leads
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Configuração
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Active Brokers -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users me-2"></i>Corretores Disponíveis</h5>
            </div>
            <div class="card-body">
                {% if brokers %}
                    <div class="row">
                        {% for broker in brokers %}
                            <div class="col-md-6 mb-3">
                                <div class="card broker-card h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-3">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ broker.username }}</h6>
                                                <small class="text-muted">{{ broker.email }}</small>
                                                <div class="mt-1">
                                                    <span class="badge bg-{{ 'success' if broker.is_active else 'secondary' }} me-1">
                                                        {{ 'Ativo' if broker.is_active else 'Inativo' }}
                                                    </span>
                                                    {% if broker.can_receive_leads %}
                                                        <span class="badge bg-info">Pode Receber Leads</span>
                                                    {% endif %}
                                                    {% if broker.can_access_reports %}
                                                        <span class="badge bg-warning">Acesso a Relatórios</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">
                                                    {% set lead_count = broker.leads|length %}
                                                    {{ lead_count }} lead{{ 's' if lead_count != 1 else '' }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhum corretor disponível</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lead Assignment History -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history me-2"></i>Atribuições Recentes de Leads</h5>
            </div>
            <div class="card-body">
                {% if assignments %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Lead</th>
                                    <th>Corretor</th>
                                    <th>Atribuído</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment, lead, broker in assignments %}
                                    <tr>
                                        <td>{{ lead.name }}</td>
                                        <td>{{ broker.username }}</td>
                                        <td>{{ assignment.assigned_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if lead.status.value == 'convertido' else 'warning' if lead.status.value == 'novo' else 'secondary' }}">
                                                {{ lead.status.value.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">Nenhuma atribuição encontrada</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
.sortable-list .broker-order-item {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
    cursor: grab;
}

.sortable-list .broker-order-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.sortable-list .broker-order-item.sortable-drag {
    opacity: 0.5;
    transform: rotate(5deg);
}

.sortable-list .broker-order-item.sortable-ghost {
    background: var(--bs-primary-bg-subtle);
    border-color: var(--bs-primary);
}

.drag-handle {
    cursor: grab;
}

.drag-handle:active {
    cursor: grabbing;
}

.order-number {
    font-size: 0.875rem;
    min-width: 2rem;
    text-align: center;
}

.broker-card {
    transition: all 0.2s ease;
}

.broker-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bs-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
}
</style>

<script>
function toggleManualOrder() {
    const mode = document.getElementById('mode').value;
    const section = document.getElementById('manualOrderSection');
    
    if (mode === 'manual') {
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
}

function addBrokerToOrder() {
    const select = document.getElementById('brokerSelect');
    const brokerId = select.value;
    const brokerName = select.options[select.selectedIndex].text;
    
    if (!brokerId) return;
    
    // Check if broker already in list
    const existingInputs = document.querySelectorAll('input[name="broker_order"]');
    for (let input of existingInputs) {
        if (input.value === brokerId) {
            alert('Corretor já está na lista de prioridade');
            return;
        }
    }
    
    // Find broker details
    const brokerData = brokersData.find(b => b.id == brokerId);
    
    // Add to list
    const orderList = document.getElementById('brokerOrderList');
    const orderNumber = orderList.children.length + 1;
    
    const brokerItem = document.createElement('div');
    brokerItem.className = 'd-flex align-items-center mb-2 broker-order-item';
    brokerItem.setAttribute('data-broker-id', brokerId);
    brokerItem.innerHTML = `
        <i class="fas fa-grip-vertical text-muted me-2 drag-handle"></i>
        <span class="badge bg-primary me-2 order-number">${orderNumber}</span>
        <div class="flex-grow-1">
            <strong>${brokerData.username}</strong>
            <small class="text-muted d-block">${brokerData.email}</small>
        </div>
        <span class="badge bg-${brokerData.is_active ? 'success' : 'secondary'} me-2">
            ${brokerData.is_active ? 'Ativo' : 'Inativo'}
        </span>
        <input type="hidden" name="broker_order" value="${brokerId}">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBrokerFromOrder(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    orderList.appendChild(brokerItem);
    
    // Reset select
    select.value = '';
    
    updateOrderNumbers();
    
    // Show success message
    showToast('Corretor adicionado à lista de prioridade', 'success');
}

function removeBrokerFromOrder(button) {
    const item = button.closest('.broker-order-item');
    item.remove();
    updateOrderNumbers();
}

function updateOrderNumbers() {
    const items = document.querySelectorAll('.broker-order-item');
    items.forEach((item, index) => {
        const badge = item.querySelector('.badge');
        badge.textContent = index + 1;
    });
}

// Initialize drag and drop
let sortable;

function initializeSortable() {
    const orderList = document.getElementById('brokerOrderList');
    if (sortable) {
        sortable.destroy();
    }
    
    sortable = new Sortable(orderList, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        onEnd: function(evt) {
            updateOrderNumbers();
            showToast('Ordem atualizada', 'info');
        }
    });
}

// Broker data for easy access
const brokersData = [
    {% for broker in brokers %}
    {
        id: {{ broker.id }},
        username: '{{ broker.username }}',
        email: '{{ broker.email }}',
        is_active: {{ broker.is_active|lower }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.role = 'alert';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleManualOrder();
    initializeSortable();
});
</script>
{% endblock %}
